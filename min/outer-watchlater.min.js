(()=>{return(t,e)=>{(async()=>{if(!document.URL.includes("//www.bilibili.com/video/av")){return}await SpinQuery.condition(()=>document.querySelector(".video-toolbar .ops .collect"),t=>{return t!==null&&t.innerText!=="--"});const t=getCsrf();const e=document.querySelector(".video-toolbar .ops .collect");if(!e){return}e.insertAdjacentHTML("afterend",`\n<span title='稍后再看' class='watchlater'>\n<i class='mdi mdi-timetable'></i>\n      稍后再看\n<div class='tip'></div>\n</span>\n`);const i=document.querySelector(".ops .watchlater");const s=document.querySelector(".ops .watchlater .tip");if(!i||!s){return}const a=async()=>{const t=await SpinQuery.select(()=>unsafeWindow.aid);if(!t){return}const e=await Ajax.getJsonWithCredentials("https://api.bilibili.com/x/v2/history/toview/web");if(e.code!==0){e.data={list:[]}}const s=e.data.list.map(t=>t.aid);if(s.includes(parseInt(t))){i.classList.add("on")}else{i.classList.remove("on")}};Observer.videoChange(async()=>{await a()});let n=0;const o=async({url:e,tipText:i})=>{const a=await Ajax.postTextWithCredentials(e,`aid=${unsafeWindow.aid}&csrf=${t}`);const o=JSON.parse(a);if(o.code!==0){logError(`稍后再看操作失败: ${o.message}`);return false}else{s.innerHTML=i;s.classList.add("show");if(n!==0){clearTimeout(n)}n=setTimeout(()=>s.classList.remove("show"),2e3);return true}};i.addEventListener("click",async()=>{i.classList.toggle("on");let t;if(i.classList.contains("on")){t=await o({url:"https://api.bilibili.com/x/v2/history/toview/add",tipText:"已添加至稍后再看"})}else{t=await o({url:"https://api.bilibili.com/x/v2/history/toview/del",tipText:"已从稍后再看移除"})}if(t===false){i.classList.toggle("on")}})})()}})();