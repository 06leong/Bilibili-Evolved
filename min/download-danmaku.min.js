(()=>{return(t,n)=>{const{getFriendlyTitle:e}=n.import("title");const{DanmakuInfo:a}=n.import("video-info");const{DanmakuConverter:i}=n.import("danmaku-converter");async function o(t){const n=e();let a={title:n};try{await loadDanmakuSettingsPanel();const t=t=>{const n=parseFloat(dq(t).style.transform.replace(/translateX\(([\d\.]+)/,"$1"));return n*4/188};const n=t=>{const n=parseFloat(dq(t).style.transform.replace(/translateX\(([\d\.]+)/,"$1"));const e={0:0,44:1,94:2,144:3,188:4}[n];return e};a.font=dq(".bilibili-player-video-danmaku-setting-right-font .bui-select-result").innerText;a.alpha=(100-parseFloat(dq(".bilibili-player-setting-opacity .bui-thumb-tooltip").innerText))/100;a.duration=(()=>{const n=18-3*t(".bilibili-player-setting-speedplus .bui-thumb");return t=>{switch(t.type){case 4:case 5:return 4;default:return n}}})();a.blockTypes=(()=>{let t=[];const n={".bilibili-player-block-filter-type[ftype=scroll]":[1,2,3],".bilibili-player-block-filter-type[ftype=top]":[5],".bilibili-player-block-filter-type[ftype=bottom]":[4],".bilibili-player-block-filter-type[ftype=color]":["color"]};for(const[e,a]of Object.entries(n)){if(dq(e).classList.contains("disabled")){t=t.concat(a)}}return t.concat(7,8)})();const e=1.4-.2*t(".bilibili-player-setting-fontsize .bui-thumb");a.resolution={x:1920*e,y:1080*e};a.bottomMarginPercent=[.75,.5,.25,0,0][n(".bilibili-player-setting-area .bui-thumb")];if(a.bottomMarginPercent===0&&dq(".bilibili-player-video-danmaku-setting-left-preventshade input").checked){a.bottomMarginPercent=.15}a.bold=dq(".bilibili-player-video-danmaku-setting-right-font-bold input").checked}catch(t){a={font:"微软雅黑",alpha:.4,duration:t=>{switch(t.type){case 4:case 5:return 4;default:return 6}},blockTypes:[7,8],resolution:{x:1920,y:1080},bottomMarginPercent:.15,bold:false}}const o=new i(a);const s=o.convertToAssDocument(t);return s.generateAss()}async function s(t){const n=e();const i=new a((unsafeWindow||window).cid);await i.fetchInfo();const s=await(async()=>{if(t===true){return new Blob([await o(i.rawXML)],{type:"text/plain"})}else{return new Blob([i.rawXML],{type:"text/plain"})}})();const l=URL.createObjectURL(s);const r=dq("#danmaku-link");const c=r.getAttribute("href");if(c){URL.revokeObjectURL(c)}r.setAttribute("download",`${n}.${t?"ass":"xml"}`);r.setAttribute("href",l);r.click()}return{export:{downloadDanmaku:s,convertToAss:o},widget:{content:`\n<a id="danmaku-link" style="display:none"></a>\n<button\n        class="gui-settings-flat-button"\n        id="download-danmaku-xml">\n<i class="icon-danmaku"></i>\n<span>下载弹幕<span>(XML)</span></span>\n</button>\n<button\n        class="gui-settings-flat-button"\n        id="download-danmaku-ass">\n<i class="icon-danmaku"></i>\n<span>下载弹幕<span>(ASS)</span></span>\n</button>\n`,condition:async()=>{let t=await SpinQuery.select(()=>(unsafeWindow||window).cid);return Boolean(t)},success:()=>{const t=dq("#download-danmaku-xml");const n=dq("#download-danmaku-ass");const e=[t,n];const a=(t,n)=>{t.addEventListener("click",async()=>{try{e.forEach(t=>t.disabled=true);await s(n)}catch(t){logError(t)}finally{e.forEach(t=>t.disabled=false)}})};a(t,false);a(n,true)}}}}})();