(()=>{return(e,t)=>{const{getFriendlyTitle:s}=t.import("title");const{VideoInfo:a,DanmakuInfo:i}=t.import("video-info");const{DownloadVideoPackage:o}=t.import("download-video-package");class n{async getDashUrl(e){if(e){return`https://api.bilibili.com/x/player/playurl?avid=${c.aid}&cid=${c.cid}&qn=${e}&otype=json&fnver=0&fnval=16`}else{return`https://api.bilibili.com/x/player/playurl?avid=${c.aid}&cid=${c.cid}&otype=json&fnver=0&fnval=16`}}async getUrl(e){if(e){return`https://api.bilibili.com/x/player/playurl?avid=${c.aid}&cid=${c.cid}&qn=${e}&otype=json`}else{return`https://api.bilibili.com/x/player/playurl?avid=${c.aid}&cid=${c.cid}&otype=json`}}}class r extends n{async getDashUrl(e){if(e){return`https://api.bilibili.com/pgc/player/web/playurl?avid=56995872&cid=99547543&qn=${e}&otype=json&fourk=1&fnval=16`}else{return`https://api.bilibili.com/pgc/player/web/playurl?avid=56995872&cid=99547543&otype=json&fourk=1&fnval=16`}}async getUrl(e){if(e){return`https://api.bilibili.com/pgc/player/web/playurl?avid=${c.aid}&cid=${c.cid}&qn=${e}&otype=json`}else{return`https://api.bilibili.com/pgc/player/web/playurl?avid=${c.aid}&cid=${c.cid}&qn=&otype=json`}}}class l extends n{constructor(e){super();this.ep=e}async getDashUrl(e){if(e){return`https://api.bilibili.com/pugv/player/web/playurl?avid=${c.aid}&cid=${c.cid}&qn=${e}&otype=json&ep_id=${this.ep}&fnver=0&fnval=16`}else{return`https://api.bilibili.com/pugv/player/web/playurl?avid=${c.aid}&cid=${c.cid}&otype=json&ep_id=${this.ep}&fnver=0&fnval=16`}}async getUrl(e){if(e){return`https://api.bilibili.com/pugv/player/web/playurl?avid=${c.aid}&cid=${c.cid}&qn=${e}&otype=json&ep_id=${this.ep}`}else{return`https://api.bilibili.com/pugv/player/web/playurl?avid=${c.aid}&cid=${c.cid}&otype=json&ep_id=${this.ep}`}}}const c={entity:new n,aid:"",cid:""};let d=[];let p=null;class h{constructor(e,t,s){this.quality=e;this.internalName=t;this.displayName=s}async downloadInfo(e=false){const t=new u(this);await t.fetchVideoInfo(e);return t}static parseFormats(e){const t=e.accept_quality;const s=e.accept_format.split(",");const a=e.accept_description;const i=t.map((e,t)=>{return new h(e,s[t],a[t])});return i}static async getAvailableDashFormats(){const e=await c.entity.getDashUrl();const t=await Ajax.getJsonWithCredentials(e);if(t.code!==0){throw new Error("获取清晰度信息失败.")}return h.parseFormats(t.data||t.result||t)}static async getAvailableFormats(){const e=await c.entity.getUrl();const t=await Ajax.getJsonWithCredentials(e);if(t.code!==0){throw new Error("获取清晰度信息失败.")}const s=t.data||t.result||t;return h.parseFormats(s)}}class u{constructor(e,t){this.fragmentSplitFactor=6*2;this.workingXhr=null;this.progressMap=new Map;this.format=e;this.fragments=t||[];this.videoSpeed=new f(this)}get danmakuOption(){return e.downloadVideoDefaultDanmaku}get isDash(){return this.fragments.some(e=>e.url.includes(".m4s"))}get totalSize(){return this.fragments.map(e=>e.size).reduce((e,t)=>e+t)}async fetchVideoInfo(s=false){if(!s){const e=await c.entity.getUrl(this.format.quality);const t=await Ajax.getTextWithCredentials(e);const s=JSON.parse(t.replace(/http:/g,"https:"));const a=s.data||s.result||s;if(a.quality!==this.format.quality){throw new Error("获取下载链接失败, 请确认当前账号有下载权限后重试.")}const i=a.durl;this.fragments=i.map(e=>{return{length:e.length,size:e.size,url:e.url,backupUrls:e.backup_url}})}else{const{dashToFragment:s,getDashInfo:a}=await t.importAsync("video-dash");const i=await a(await c.entity.getDashUrl(this.format.quality),this.format.quality);console.log(i.videoDashes);const o=(()=>{const t=t=>t.videoCodec===e.downloadVideoDashCodec;if(i.videoDashes.some(t)){return i.videoDashes.filter(t).sort(ascendingSort(e=>e.bandWidth))[0]}else{return i.videoDashes.sort(ascendingSort(e=>e.bandWidth))[0]}})();const n=i.audioDashes.sort(descendingSort(e=>e.bandWidth))[0];this.fragments=[s(o),s(n)]}return this.fragments}updateProgress(){const e=this.progressMap?[...this.progressMap.values()].reduce((e,t)=>e+t,0)/this.totalSize:0;if(e>1||e<0){console.error(`[下载视频] 进度异常: ${e}`,this.progressMap.values())}this.progress&&this.progress(e)}cancelDownload(){this.videoSpeed.stopMeasure();if(this.workingXhr!==null){this.workingXhr.forEach(e=>e.abort())}else{logError("Cancel Download Failed: forEach in this.workingXhr not found.")}}downloadFragment(e){const t=[];const s=this.isDash?4*1024*1024:16*1024*1024;let a;if(e.size<=s*6){a=e.size/this.fragmentSplitFactor}else{a=s}let i=0;const o=e=>[...this.progressMap.keys()].indexOf(e)+1;while(i<e.size){const s=Math.min(e.size-1,Math.round(i+a));const n=`bytes=${i}-${s}`;const r=s-i+1;t.push(new Promise((t,s)=>{const a=new XMLHttpRequest;a.open("GET",e.url);a.responseType="arraybuffer";a.withCredentials=false;a.addEventListener("progress",e=>{console.log(`[下载视频] 视频片段${o(a)}下载进度: ${e.loaded}/${r} bytes loaded, ${n}`);this.progressMap.set(a,e.loaded);this.updateProgress()});a.addEventListener("load",()=>{if((""+a.status)[0]==="2"){console.log(`[下载视频] 视频片段${o(a)}下载完成`);t(a.response)}else{s(`视频片段${o(a)}请求失败, response = ${a.status}`)}});a.addEventListener("abort",()=>s("canceled"));a.addEventListener("error",()=>{console.error(`[下载视频] 视频片段${o(a)}下载失败: ${n}`);this.progressMap.set(a,0);this.updateProgress();a.open("GET",e.url);a.setRequestHeader("Range",n);a.send()});a.setRequestHeader("Range",n);this.progressMap.set(a,0);a.send();this.workingXhr.push(a)}));i=Math.round(i+a)+1}return Promise.all(t)}async copyUrl(){const e=this.fragments.map(e=>e.url).reduce((e,t)=>e+"\r\n"+t);GM.setClipboard(e,"text")}async showUrl(){const e=this.fragments.map(e=>`\n<a class="download-link" href="${e.url}">${e.url}</a>\n`).reduce((e,t)=>e+"\r\n"+t);Toast.success(e+`<a class="link" id="copy-link" style="cursor: pointer;margin: 8px 0 0 0;">复制全部</a>`,"显示链接");const t=await SpinQuery.select("#copy-link");t.addEventListener("click",async()=>{await this.copyUrl()})}async exportData(e=false){const t=JSON.stringify([{fragments:this.fragments,title:s(),totalSize:this.fragments.map(e=>e.size).reduce((e,t)=>e+t),referer:document.URL.replace(window.location.search,"")}]);if(e){GM.setClipboard(t,"text")}else{const e=new Blob([t],{type:"text/json"});const a=await this.downloadDanmaku();const i=new o;i.add(`${s()}.json`,e);i.add(s()+"."+this.danmakuOption.toLowerCase(),a);await i.emit(`${s()}.zip`)}}async exportAria2(a=false){if(a){const a=await this.downloadDanmaku();const i=new o;i.add(`${s()}.${this.danmakuOption==="ASS"?"ass":"xml"}`,a);await i.emit();const n=e.aria2RpcOption;const r=this.fragments.map((e,t)=>{let a="";if(this.fragments.length>1){a=" - "+(t+1)}const i=[];if(n.secretKey!==""){i.push(`token:${n.secretKey}`)}i.push([e.url]);i.push({referer:document.URL.replace(window.location.search,""),"user-agent":UserAgent,out:`${s()}${a}${this.extension(e)}`,split:this.fragmentSplitFactor,dir:n.baseDir+n.dir||undefined,"max-download-limit":n.maxDownloadLimit||undefined});const o=encodeURIComponent(`${s()}${a}`);return{params:i,id:o}});const{sendRpc:l}=await t.importAsync("aria2-rpc");await l(r)}else{const e=`\n# Generated by Bilibili Evolved Video Export\n# https://github.com/the1812/Bilibili-Evolved/\n${this.fragments.map((e,t)=>{let a="";if(this.fragments.length>1){a=" - "+(t+1)}return`\n${e.url}\n  referer=${document.URL.replace(window.location.search,"")}\n  user-agent=${UserAgent}\n  out=${s()}${a}${this.extension(e)}\n  split=${this.fragmentSplitFactor}\n`.trim()}).join("\n")}\n`.trim();const t=new Blob([e],{type:"text/plain"});const a=await this.downloadDanmaku();const i=new o;i.add(`${s()}.txt`,t);i.add(s()+"."+this.danmakuOption.toLowerCase(),a);await i.emit(`${s()}.zip`)}}extension(e){const t=e||this.fragments[0];const s=[".flv",".mp4",".m4s"].find(e=>t.url.includes(e));if(s){return s}else{console.warn("No extension detected.");return".flv"}}async downloadDanmaku(){if(this.danmakuOption!=="无"){const e=new i(c.cid);await e.fetchInfo();if(this.danmakuOption==="XML"){return e.rawXML}else{const{convertToAss:s}=await t.importAsync("download-danmaku");return s(e.rawXML)}}else{return null}}async download(){this.workingXhr=[];this.progressMap=new Map;this.updateProgress();const e=[];this.videoSpeed.startMeasure();for(const t of this.fragments){const s=await this.downloadFragment(t);e.push(s)}if(e.length<1){throw new Error("下载失败.")}const t=s();const a=new o;e.forEach((s,i)=>{let o;const n=this.fragments[i];if(e.length>1){o=`${t} - ${i+1}${this.extension(n)}`}else{o=`${t}${this.extension(n)}`}a.add(o,new Blob(Array.isArray(s)?s:[s],{type:this.extension(n)===".flv"?"video/x-flv":"video/mp4"}))});const i=await this.downloadDanmaku();a.add(`${s()}.${this.danmakuOption==="ASS"?"ass":"xml"}`,i);await a.emit(t+".zip");this.progress&&this.progress(0);this.videoSpeed.stopMeasure()}}class f{constructor(e){this.lastProgress=0;this.measureInterval=1e3;this.workingDownloader=e}startMeasure(){this.intervalTimer=setInterval(()=>{const e=this.workingDownloader.progressMap?[...this.workingDownloader.progressMap.values()].reduce((e,t)=>e+t,0):0;const t=e-this.lastProgress;if(this.speedUpdate!==undefined){this.speedUpdate(formatFileSize(t)+"/s")}this.lastProgress=e},this.measureInterval)}stopMeasure(){clearInterval(this.intervalTimer)}}async function m(){const e=await SpinQuery.select(()=>(unsafeWindow||window).aid);const t=await SpinQuery.select(()=>(unsafeWindow||window).cid);if(!(e&&t)){return false}c.aid=e;c.cid=t;if(document.URL.includes("bangumi")){c.entity=new r}else if(document.URL.includes("cheese")){const e=document.URL.match(/cheese\/play\/ep([\d]+)/);c.entity=new l(e[1])}else{c.entity=new n}try{d=await h.getAvailableFormats()}catch(e){return false}return true}async function w(){p=d[0];t.applyStyle("downloadVideoStyle");dq("#download-video").addEventListener("click",()=>{dq(".download-video").classList.toggle("opened");dq(".gui-settings-mask").click()});dq("#download-video").addEventListener("mouseover",()=>{document.body.insertAdjacentHTML("beforeend",t.import("downloadVideoHtml"));g()},{once:true})}async function g(){let n;const r=new Vue({el:".download-video",components:{VDropdown:()=>t.importAsync("v-dropdown.vue"),VCheckbox:()=>t.importAsync("v-checkbox.vue"),RpcProfiles:()=>t.importAsync("aria2-rpc-profiles.vue")},data:{downloadSingle:true,coverUrl:EmptyImageUrl,aid:c.aid,cid:c.cid,dashModel:{value:e.downloadVideoFormat,items:["flv","dash"]},qualityModel:{value:p.displayName,items:d.map(e=>e.displayName)},danmakuModel:{value:e.downloadVideoDefaultDanmaku,items:["无","XML","ASS"]},codecModel:{value:e.downloadVideoDashCodec,items:["AVC/H.264","HEVC/H.265"]},progressPercent:0,size:"获取大小中",blobUrl:"",episodeList:[],downloading:false,speed:"",batch:false,rpcSettings:e.aria2RpcOption,showRpcSettings:false,busy:false,saveRpcSettingsText:"保存配置",enableDash:e.enableDashDownload,lastDirectDownloadLink:""},computed:{displaySize(){if(typeof this.size==="string"){return this.size}return formatFileSize(this.size)},sizeWarning(){if(typeof this.size==="string"){return false}return this.size>1073741824},selectedEpisodeCount(){return this.episodeList.filter(e=>e.checked).length},dash(){return this.dashModel.value==="dash"}},methods:{close(){this.$el.classList.remove("opened")},danmakuOptionChange(){e.downloadVideoDefaultDanmaku=this.danmakuModel.value},async codecChange(){e.downloadVideoDashCodec=this.codecModel.value;await this.formatChange()},async dashChange(){console.log("dash change");e.downloadVideoFormat=this.dashModel.value;const t=this.dashModel.value;let s=[];if(t==="flv"){s=await h.getAvailableFormats()}else{s=await h.getAvailableDashFormats()}d=s;[p]=t;this.qualityModel.items=s.map(e=>e.displayName);[this.qualityModel.value]=this.qualityModel.items;await this.formatChange()},async formatChange(){console.log("format change");const e=this.getFormat();try{this.size="获取大小中";const t=await e.downloadInfo(this.dash);this.size=t.totalSize}catch(e){this.size="获取大小失败";throw e}},getFormat(){const e=d.find(e=>e.displayName===this.qualityModel.value);if(!e){console.error(`No format found. model value = ${this.qualityModel.value}`);return null}return e},async exportData(e){if(this.busy===true){return}try{this.busy=true;if(!this.downloadSingle){await this.exportBatchData(e);return}const a=this.getFormat();const i=await a.downloadInfo(this.dash);switch(e){case"copyLink":await i.copyUrl();Toast.success("已复制链接到剪贴板.","下载视频",3e3);break;case"showLink":await i.showUrl();break;case"aria2":await i.exportAria2(false);break;case"aria2RPC":await i.exportAria2(true);break;case"copyVLD":await i.exportData(true);Toast.success("已复制VLD数据到剪贴板.","下载视频",3e3);break;case"exportVLD":await i.exportData(false);break;case"ffmpegFragments":if(i.fragments.length<2){Toast.info("当前视频没有分段.","分段列表",3e3)}else{const{getFragmentsList:e}=await t.importAsync("ffmpeg-support");const a=new o;a.add("ffmpeg-files.txt",e(i.fragments.length,s(),i.extension(i.fragments[0])));await a.emit()}break;default:break}}catch(e){logError(e)}finally{this.busy=false}},async exportBatchData(e){const a=this.episodeList;if(a.every(e=>e.checked===false)){Toast.info("请至少选择1集或以上的数量!","批量导出",3e3);return}const n=e=>{const t=a.find(t=>t.cid===e.cid);if(t===undefined){return false}return t.checked};const r=this.getFormat();if(this.danmakuModel.value!=="无"){const e=Toast.info("下载弹幕中...","批量导出");const s=new o;try{if(this.danmakuModel.value==="XML"){for(const e of a.filter(n)){const t=new i(e.cid);await t.fetchInfo();s.add(e.title+".xml",t.rawXML)}}else{const{convertToAss:e}=await t.importAsync("download-danmaku");for(const t of a.filter(n)){const a=new i(t.cid);await a.fetchInfo();s.add(t.title+".ass",await e(a.rawXML))}}await s.emit(this.cid+".danmakus.zip")}catch(e){logError(`弹幕下载失败`)}finally{e.dismiss()}}const l=Toast.info("获取链接中...","批量导出");const c=this.batchExtractor;c.itemFilter=n;let d;try{switch(e){case"aria2":d=await c.collectAria2(r,l,false);await o.single(s(false)+".txt",new Blob([d],{type:"text/plain"}),{ffmpeg:this.ffmpegOption});return;case"aria2RPC":await c.collectAria2(r,l,true);Toast.success(`成功发送了批量请求.`,"aria2 RPC",3e3);return;case"copyVLD":GM.setClipboard(await c.collectData(r,l),{mimetype:"text/plain"});Toast.success("已复制批量vld数据到剪贴板.","批量导出",3e3);return;case"exportVLD":d=await c.collectData(r,l);await o.single(s(false)+".json",new Blob([d],{type:"text/json"}),{ffmpeg:this.ffmpegOption});return;case"ffmpegFragments":const a=await c.getRawItems(r);const i=new u(r,a[0].fragments);const{getBatchFragmentsList:n}=await t.importAsync("ffmpeg-support");const p=n(a,i.extension());if(!p){Toast.info("所有选择的分P都没有分段.","分段列表",3e3)}else{const e=new o;for(const[t,s]of p.entries()){e.add(t,s)}await e.emit(escapeFilename(`${s(false)}.zip`))}break;case"ffmpegEpisodes":break;default:return}}catch(e){logError(e)}finally{l.dismiss()}},async checkBatch(){const e=["/www.bilibili.com/bangumi","/www.bilibili.com/video/av"];if(!e.some(e=>document.URL.includes(e))){this.batch=false;this.episodeList=[];return}const{BatchExtractor:s}=await t.importAsync("batch-download");if(await s.test()!==true){this.batch=false;this.episodeList=[];return}const a=this.batchExtractor=new s;this.batch=true;this.episodeList=(await a.getItemList()).map((e,t)=>{return{aid:e.aid,cid:e.cid,title:e.title,index:t,checked:true}})},cancelDownload(){if(n){n.cancelDownload()}},async startDownload(){const e=this.getFormat();try{this.downloading=true;const t=await e.downloadInfo(this.dash);t.videoSpeed.speedUpdate=(e=>this.speed=e);t.progress=(e=>{this.progressPercent=Math.trunc(e*100)});n=t;await t.download();this.lastDirectDownloadLink=o.lastPackageUrl}catch(e){if(e!=="canceled"){logError(e)}this.progressPercent=0}finally{this.downloading=false;this.speed=""}},selectAllEpisodes(){this.episodeList.forEach(e=>e.checked=true)},unselectAllEpisodes(){this.episodeList.forEach(e=>e.checked=false)},inverseAllEpisodes(){this.episodeList.forEach(e=>e.checked=!e.checked)},toggleRpcSettings(){this.showRpcSettings=!this.showRpcSettings},saveRpcSettings(){if(this.rpcSettings.host===""){this.rpcSettings.host="127.0.0.1"}if(this.rpcSettings.port===""){this.rpcSettings.port="6800"}e.aria2RpcOption=this.rpcSettings;const t=e.aria2RpcOptionProfiles.find(t=>t.name===e.aria2RpcOptionSelectedProfile);if(t){Object.assign(t,this.rpcSettings);e.aria2RpcOptionProfiles=e.aria2RpcOptionProfiles}this.saveRpcSettingsText="已保存";setTimeout(()=>this.saveRpcSettingsText="保存配置",2e3)},updateProfile(t){e.aria2RpcOption=this.rpcSettings=_.omit(t,"name")}},async mounted(){}});Observer.videoChange(async()=>{r.close();r.batch=false;r.downloadSingle=true;const e=dq("#download-video");const t=await m();e.style.display=t?"flex":"none";if(!t){return}r.aid=c.aid;r.cid=c.cid;try{const e=new a(c.aid);await e.fetchInfo();r.coverUrl=e.coverUrl.replace("http:","https:")}catch(e){r.coverUrl=EmptyImageUrl}r.dashChange();await r.checkBatch()})}return{widget:{content:`\n<button class="gui-settings-flat-button" style="position: relative; z-index: 100;" id="download-video">\n<i class="icon-download"></i>\n<span>下载视频</span>\n</button>`,condition:m,success:w}}}})();